{% extends "base.html" %}
{% block title %}Gestión de Libros{% endblock %}
{% block content %}
<div class="container">
    <h2>Gestión de Libros</h2>
    <button onclick="openModal('addBookModal')">Agregar Libro</button>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Año</th>
                <th>Resumen</th>
                <th>Editorial</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <!-- Vulnerabilidad: XSS posible al no sanitizar book[1], book[4], book[5] -->
            <tr>
                <td>{{ book[0] }}</td>
                <td>{{ book[1] }}</td>
                <td>{{ book[2] }}</td>
                <td>{{ book[3] }}</td>
                <td>{{ book[4] }}</td>
                <td>{{ book[5] }}</td>
                <td>
                    <button onclick="openEditModal({{ book[0] }}, '{{ book[1] }}', {{ book[3] }}, '{{ book[4] }}', '{{ book[5] }}')">Editar</button>
                    <form method="POST" style="display:inline;">
                        <input type="hidden" name="id" value="{{ book[0] }}">
                        <button type="submit" name="delete">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Modal para agregar libro -->
    <!-- Vulnerabilidad: Sin token CSRF -->
    <div id="addBookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addBookModal')">&times;</span>
            <h3>Agregar Libro</h3>
            <form method="POST">
                <label for="title">Título:</label>
                <input type="text" id="title" name="title" required>
                <label for="author_id">Autor:</label>
                <select id="author_id" name="author_id" required>
                    {% for author in authors %}
                    <option value="{{ author[0] }}">{{ author[1] }}</option>
                    {% endfor %}
                </select>
                <label for="publication_year">Año de Publicación:</label>
                <input type="number" id="publication_year" name="publication_year">
                <label for="summary">Resumen:</label>
                <textarea id="summary" name="summary"></textarea>
                <label for="publisher">Editorial:</label>
                <input type="text" id="publisher" name="publisher">
                <button type="submit" name="add">Agregar</button>
            </form>
        </div>
    </div>

    <!-- Modal para editar libro -->
    <div id="editBookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editBookModal')">&times;</span>
            <h3>Editar Libro</h3>
            <form method="POST">
                <input type="hidden" id="edit_id" name="id">
                <label for="edit_title">Título:</label>
                <input type="text" id="edit_title" name="title" required>
                <label for="edit_author_id">Autor:</label>
                <select id="edit_author_id" name="author_id" required>
                    {% for author in authors %}
                    <option value="{{ author[0] }}">{{ author[1] }}</option>
                    {% endfor %}
                </select>
                <label for="edit_publication_year">Año de Publicación:</label>
                <input type="number" id="edit_publication_year" name="publication_year">
                <label for="edit_summary">Resumen:</label>
                <textarea id="edit_summary" name="summary"></textarea>
                <label for="edit_publisher">Editorial:</label>
                <input type="text" id="edit_publisher" name="publisher">
                <button type="submit" name="update">Actualizar</button>
            </form>
        </div>
    </div>
</div>
<script>
function openEditModal(id, title, publication_year, summary, publisher) {
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_title').value = title;
    document.getElementById('edit_publication_year').value = publication_year;
    document.getElementById('edit_summary').value = summary;
    document.getElementById('edit_publisher').value = publisher;
    document.getElementById('editBookModal').style.display = 'block';
}
</script>
{% endblock %}